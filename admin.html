<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin 3DPANNE</title>
  <link rel="stylesheet" href="css/theme.css" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
</head>
<body class="admin-page">

<div class="admin-container">
  <h1>Interface admin ‚Äì Produits & projets</h1>
  <p class="admin-help">Renseigne un token GitHub personnel avec droits sur le d√©p√¥t <code>Disensor/disensor.github.io</code> et pr√©cise la branche √† mettre √† jour.</p>

  <div id="auth" class="admin-auth">
    <div class="admin-auth-grid">
      <label for="token">Token GitHub :</label>
      <input type="password" id="token" placeholder="ghp_..." autocomplete="off">
      <label for="branch">Branche √† modifier :</label>
      <input type="text" id="branch" placeholder="main" autocomplete="off">
    </div>
    <button type="button" class="admin-auth-button" onclick="auth()">Se connecter</button>
    <p class="admin-hint">Le token doit avoir au minimum le droit <code>repo</code>. Tu peux conserver la branche entre les sessions, elle est m√©moris√©e localement.</p>
    <p id="authStatus" class="status hidden" role="status" aria-live="polite"></p>
  </div>

  <section id="productAdmin" class="admin-block hidden">
    <h2>Produits de la boutique</h2>
    <form id="productForm">
      <div class="form-grid">
        <label>R√©f√©rence
          <input type="text" id="productRef" required>
        </label>
        <label>Nom du produit
          <input type="text" id="productName" required>
        </label>
        <label>Type de fichier
          <select id="productType">
            <option value="STL">STL</option>
            <option value="STEP">STEP</option>
            <option value="PDF">PDF</option>
          </select>
        </label>
        <label>Prix
          <input type="text" id="productPrice" placeholder="Ex. 29,90‚Ç¨">
        </label>
      </div>
      <label>Description
        <textarea id="productDescription" rows="3" required></textarea>
@@ -82,205 +88,528 @@
      <label>Description d√©taill√©e
        <textarea id="projectDescription" rows="4" required></textarea>
      </label>
      <label>Points forts (un par ligne)
        <textarea id="projectHighlights" rows="3" placeholder="Ligne 1\nLigne 2"></textarea>
      </label>
      <label>Services li√©s (s√©par√©s par des virgules)
        <input type="text" id="projectServices" placeholder="Mod√©lisation CAO, Impression 3D">
      </label>
      <label>Galerie (URLs s√©par√©es par des virgules)
        <input type="text" id="projectGallery" placeholder="images/projects/photo1.jpg, images/projects/photo2.jpg">
      </label>
      <label>Texte CTA
        <input type="text" id="projectCta" placeholder="Commander une pi√®ce similaire">
      </label>
      <label>Lien CTA
        <input type="text" id="projectCtaLink" placeholder="commandes.html?type=prototype">
      </label>
      <button type="submit">Enregistrer le projet</button>
      <p id="projectStatus" class="status hidden"></p>
    </form>

    <h3>Projets existants</h3>
    <div id="projectList" class="admin-list">Chargement‚Ä¶</div>
  </section>

  <section id="serviceAdmin" class="admin-block hidden">
    <h2>Services</h2>
    <form id="serviceForm">
      <div class="form-grid">
        <label>Identifiant (slug)
          <input type="text" id="serviceSlug" required>
        </label>
        <label>Titre
          <input type="text" id="serviceTitle" required>
        </label>
        <label>Ic√¥ne
          <input type="text" id="serviceIcon" placeholder="üõ†Ô∏è">
        </label>
        <label>Tagline
          <input type="text" id="serviceTagline">
        </label>
      </div>
      <label>R√©sum√© (aper√ßu)
        <textarea id="serviceSummary" rows="2"></textarea>
      </label>
      <label>Description d√©taill√©e
        <textarea id="serviceDetails" rows="4" required></textarea>
      </label>
      <label>Livrables (un par ligne)
        <textarea id="serviceDeliverables" rows="3" placeholder="Livrable 1\nLivrable 2"></textarea>
      </label>
      <label>Outils (s√©par√©s par des virgules)
        <input type="text" id="serviceTools" placeholder="SolidWorks, Fusion 360">
      </label>
      <div class="form-grid">
        <label>Tarif
          <input type="text" id="servicePrice" placeholder="√Ä partir de 30 ‚Ç¨ / h">
        </label>
        <label>D√©lai indicatif
          <input type="text" id="serviceTurnaround" placeholder="1 √† 5 jours">
        </label>
        <label>Texte CTA
          <input type="text" id="serviceCta" placeholder="Demander un devis">
        </label>
        <label>Lien CTA
          <input type="text" id="serviceCtaLink" placeholder="commandes.html?type=cao">
        </label>
      </div>
      <button type="submit">Enregistrer le service</button>
      <p id="serviceStatus" class="status hidden"></p>
    </form>

    <h3>Services existants</h3>
    <div id="serviceList" class="admin-list">Chargement‚Ä¶</div>
  </section>

  <section id="faqAdmin" class="admin-block hidden">
    <h2>FAQ</h2>
    <form id="faqForm">
      <label>Question
        <input type="text" id="faqQuestion" required>
      </label>
      <label>R√©ponse
        <textarea id="faqAnswer" rows="3" required></textarea>
      </label>
      <button type="submit">Enregistrer la question</button>
      <p id="faqStatus" class="status hidden"></p>
    </form>

    <h3>Questions existantes</h3>
    <div id="faqList" class="admin-list">Chargement‚Ä¶</div>
  </section>

  <section id="testimonialAdmin" class="admin-block hidden">
    <h2>T√©moignages</h2>
    <form id="testimonialForm">
      <label>Citation
        <textarea id="testimonialQuote" rows="3" required></textarea>
      </label>
      <div class="form-grid">
        <label>Auteur
          <input type="text" id="testimonialAuthor" required>
        </label>
        <label>R√¥le / soci√©t√©
          <input type="text" id="testimonialRole" placeholder="Responsable maintenance">
        </label>
      </div>
      <button type="submit">Enregistrer le t√©moignage</button>
      <p id="testimonialStatus" class="status hidden"></p>
    </form>

    <h3>T√©moignages existants</h3>
    <div id="testimonialList" class="admin-list">Chargement‚Ä¶</div>
  </section>

  <section id="creditAdmin" class="admin-block hidden">
    <h2>Cr√©dits visuels</h2>
    <form id="creditForm">
      <label>Titre du m√©dia
        <input type="text" id="creditTitle" required>
      </label>
      <div class="form-grid">
        <label>Type
          <input type="text" id="creditType" placeholder="Photo, Ic√¥ne‚Ä¶">
        </label>
        <label>Auteur / Propri√©taire
          <input type="text" id="creditAuthor" required>
        </label>
        <label>Licence
          <input type="text" id="creditLicense" placeholder="¬© 3DPANNE, CC-BY‚Ä¶">
        </label>
        <label>Lien source
          <input type="url" id="creditUrl" placeholder="https://">
        </label>
      </div>
      <button type="submit">Enregistrer le cr√©dit</button>
      <p id="creditStatus" class="status hidden"></p>
    </form>

    <h3>Cr√©dits existants</h3>
    <div id="creditList" class="admin-list">Chargement‚Ä¶</div>
  </section>
</div>

<script>
let githubToken = '';
const repoOwner = 'Disensor';
const repoName = 'disensor.github.io';
const apiBase = 'https://api.github.com';
const branchParam = new URLSearchParams(window.location.search).get('branch');
const storedBranch = localStorage.getItem('admin-branch');
let repoBranch = (branchParam && branchParam.trim()) || storedBranch || 'main';
const branchInput = document.getElementById('branch');

if (branchInput) {
  branchInput.value = repoBranch;
  branchInput.addEventListener('input', () => {
    repoBranch = branchInput.value.trim();
  });
  branchInput.addEventListener('change', () => {
    repoBranch = branchInput.value.trim() || 'main';
    localStorage.setItem('admin-branch', repoBranch);
  });
}

function githubHeaders({ json } = {}) {
  const headers = {
    Accept: 'application/vnd.github+json',
    'X-GitHub-Api-Version': '2022-11-28'
  };
  if (githubToken) {
    headers.Authorization = `token ${githubToken}`;
  }
  if (json) {
    headers['Content-Type'] = 'application/json';
  }
  return headers;
}

function buildContentUrl(path) {
  const url = new URL(`${apiBase}/repos/${repoOwner}/${repoName}/contents/${path}`);
  if (repoBranch) {
    url.searchParams.set('ref', repoBranch);
  }
  return url.toString();
}

const state = {
  products: { data: [], sha: null, editIndex: null },
  projects: { data: [], sha: null, editIndex: null },
  services: { data: [], sha: null, editIndex: null },
  faq: { data: [], sha: null, editIndex: null },
  testimonials: { data: [], sha: null, editIndex: null },
  credits: { data: [], sha: null, editIndex: null }
};

function decodeBase64Utf8(base64) {
  const binaryString = atob(base64.replace(/\n/g, ''));
  const bytes = new Uint8Array([...binaryString].map((c) => c.charCodeAt(0)));
  const decoder = new TextDecoder('utf-8');
  return decoder.decode(bytes);
}

async function auth() {
  githubToken = document.getElementById('token').value.trim();
  repoBranch = (branchInput && branchInput.value.trim()) || repoBranch || 'main';
  localStorage.setItem('admin-branch', repoBranch);
  if (!githubToken) {
    setStatus('authStatus', 'Merci de renseigner un token.', 'error');
    return;
  }
  setStatus('authStatus', 'V√©rification du token‚Ä¶');
  try {
    const res = await fetch(`${apiBase}/user`, { headers: githubHeaders() });
    if (!res.ok) {
      throw new Error('Token invalide ou non autoris√©.');
    }
    const user = await res.json();
    setStatus('authStatus', `‚úÖ Connect√© en tant que ${user.login} (branche ${repoBranch}).`, 'success');
    document.getElementById('auth').classList.add('hidden');
    document.getElementById('productAdmin').classList.remove('hidden');
    document.getElementById('projectAdmin').classList.remove('hidden');
    document.getElementById('serviceAdmin').classList.remove('hidden');
    document.getElementById('faqAdmin').classList.remove('hidden');
    document.getElementById('testimonialAdmin').classList.remove('hidden');
    document.getElementById('creditAdmin').classList.remove('hidden');
    loadProducts();
    loadProjects();
    loadServices();
    loadFaq();
    loadTestimonials();
    loadCredits();
  } catch (error) {
    console.error(error);
    setStatus('authStatus', `‚ùå ${error.message}`, 'error');
  }
}

async function fetchFile(path) {
  const res = await fetch(buildContentUrl(path), { headers: githubHeaders() });
  if (!res.ok) {
    throw new Error(`Erreur lors du chargement de ${path} (branche ${repoBranch})`);
  }
  const data = await res.json();
  return {
    data: JSON.parse(decodeBase64Utf8(data.content)),
    sha: data.sha
  };
}

async function updateFile(path, content, sha, message) {
  const res = await fetch(buildContentUrl(path), {
    method: 'PUT',
    headers: githubHeaders({ json: true }),
    body: JSON.stringify({
      message,
      content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
      sha,
      branch: repoBranch
    })
  });
  if (!res.ok) {
    const error = await res.json();
    throw new Error(error.message || 'Impossible de mettre √† jour le fichier');
  }
  return res.json();
}

function renderProductList() {
  const list = document.getElementById('productList');
  list.innerHTML = '';
  state.products.data.forEach((product, index) => {
    const div = document.createElement('div');
    div.className = 'admin-card';
    div.innerHTML = `
      <strong>${product.name}</strong> (${product.ref}) ‚Äì ${product.price || 'Sur devis'}<br>
      <button type="button" onclick="editProduct(${index})">‚úèÔ∏è Modifier</button>
      <button type="button" onclick="deleteProduct(${index})">üóëÔ∏è Supprimer</button>
    `;
    list.appendChild(div);
  });
  if (!list.children.length) {
    list.textContent = 'Aucun produit enregistr√©.';
  }
}

function renderProjectList() {
  const list = document.getElementById('projectList');
  list.innerHTML = '';
  state.projects.data.forEach((project, index) => {
    const div = document.createElement('div');
    div.className = 'admin-card';
    div.innerHTML = `
      <strong>${project.title}</strong> (${project.id})<br>
      <em>${project.summary}</em><br>
      <button type="button" onclick="editProject(${index})">‚úèÔ∏è Modifier</button>
      <button type="button" onclick="deleteProject(${index})">üóëÔ∏è Supprimer</button>
    `;
    list.appendChild(div);
  });
  if (!list.children.length) {
    list.textContent = 'Aucun projet enregistr√©.';
  }
}

function renderServiceList() {
  const list = document.getElementById('serviceList');
  list.innerHTML = '';
  state.services.data.forEach((service, index) => {
    const div = document.createElement('div');
    div.className = 'admin-card';
    div.innerHTML = `
      <strong>${service.title}</strong> (${service.slug})<br>
      ${service.price || 'Sur devis'}<br>
      <button type="button" onclick="editService(${index})">‚úèÔ∏è Modifier</button>
      <button type="button" onclick="deleteService(${index})">üóëÔ∏è Supprimer</button>
    `;
    list.appendChild(div);
  });
  if (!list.children.length) {
    list.textContent = 'Aucun service enregistr√©.';
  }
}

function renderFaqList() {
  const list = document.getElementById('faqList');
  list.innerHTML = '';
  state.faq.data.forEach((item, index) => {
    const div = document.createElement('div');
    div.className = 'admin-card';
    const answer = item.answer || '';
    const preview = answer.length > 120 ? `${answer.slice(0, 117)}‚Ä¶` : answer;
    div.innerHTML = `
      <strong>${item.question}</strong><br>
      <em>${preview}</em><br>
      <button type="button" onclick="editFaq(${index})">‚úèÔ∏è Modifier</button>
      <button type="button" onclick="deleteFaq(${index})">üóëÔ∏è Supprimer</button>
    `;
    list.appendChild(div);
  });
  if (!list.children.length) {
    list.textContent = 'Aucune question pour le moment.';
  }
}

function renderTestimonialList() {
  const list = document.getElementById('testimonialList');
  list.innerHTML = '';
  state.testimonials.data.forEach((item, index) => {
    const div = document.createElement('div');
    div.className = 'admin-card';
    const quote = item.quote || '';
    div.innerHTML = `
      <strong>${item.author || 'Auteur'}</strong> ${item.role ? `(${item.role})` : ''}<br>
      ¬´ ${quote.slice(0, 120)}${quote.length > 120 ? '‚Ä¶' : ''} ¬ª<br>
      <button type="button" onclick="editTestimonial(${index})">‚úèÔ∏è Modifier</button>
      <button type="button" onclick="deleteTestimonial(${index})">üóëÔ∏è Supprimer</button>
    `;
    list.appendChild(div);
  });
  if (!list.children.length) {
    list.textContent = 'Aucun t√©moignage enregistr√©.';
  }
}

function renderCreditList() {
  const list = document.getElementById('creditList');
  list.innerHTML = '';
  state.credits.data.forEach((item, index) => {
    const div = document.createElement('div');
    div.className = 'admin-card';
    div.innerHTML = `
      <strong>${item.title}</strong> ‚Äì ${item.author || 'Auteur inconnu'}<br>
      ${item.license || ''}<br>
      <button type="button" onclick="editCredit(${index})">‚úèÔ∏è Modifier</button>
      <button type="button" onclick="deleteCredit(${index})">üóëÔ∏è Supprimer</button>
    `;
    list.appendChild(div);
  });
  if (!list.children.length) {
    list.textContent = 'Aucun cr√©dit enregistr√©.';
  }
}

async function loadProducts() {
  try {
    document.getElementById('productList').textContent = 'Chargement‚Ä¶';
    const file = await fetchFile('data/products.json');
    state.products.data = file.data;
    state.products.sha = file.sha;
    renderProductList();
  } catch (error) {
    document.getElementById('productList').textContent = 'Erreur de chargement des produits.';
    console.error(error);
  }
}

async function loadProjects() {
  try {
    document.getElementById('projectList').textContent = 'Chargement‚Ä¶';
    const file = await fetchFile('data/projects.json');
    state.projects.data = file.data;
    state.projects.sha = file.sha;
    renderProjectList();
  } catch (error) {
    document.getElementById('projectList').textContent = 'Erreur de chargement des projets.';
    console.error(error);
  }
}

async function loadServices() {
  try {
    document.getElementById('serviceList').textContent = 'Chargement‚Ä¶';
    const file = await fetchFile('data/services.json');
    state.services.data = file.data;
    state.services.sha = file.sha;
    renderServiceList();
  } catch (error) {
    document.getElementById('serviceList').textContent = 'Erreur de chargement des services.';
    console.error(error);
  }
}

async function loadFaq() {
  try {
    document.getElementById('faqList').textContent = 'Chargement‚Ä¶';
    const file = await fetchFile('data/faq.json');
    state.faq.data = file.data;
    state.faq.sha = file.sha;
    renderFaqList();
  } catch (error) {
    document.getElementById('faqList').textContent = 'Erreur de chargement de la FAQ.';
    console.error(error);
  }
}

async function loadTestimonials() {
  try {
    document.getElementById('testimonialList').textContent = 'Chargement‚Ä¶';
    const file = await fetchFile('data/testimonials.json');
    state.testimonials.data = file.data;
    state.testimonials.sha = file.sha;
    renderTestimonialList();
  } catch (error) {
    document.getElementById('testimonialList').textContent = 'Erreur de chargement des t√©moignages.';
    console.error(error);
  }
}

async function loadCredits() {
  try {
    document.getElementById('creditList').textContent = 'Chargement‚Ä¶';
    const file = await fetchFile('data/credits.json');
    state.credits.data = file.data;
    state.credits.sha = file.sha;
    renderCreditList();
  } catch (error) {
    document.getElementById('creditList').textContent = 'Erreur de chargement des cr√©dits.';
    console.error(error);
  }
}

function setStatus(id, message, type = '') {
  const el = document.getElementById(id);
  el.textContent = message;
  el.classList.remove('hidden', 'error', 'success');
  if (type) el.classList.add(type);
  if (type === 'success') {
    setTimeout(() => el.classList.add('hidden'), 4000);
  }
}

function clearProductForm() {
  document.getElementById('productForm').reset();
  state.products.editIndex = null;
}

function clearProjectForm() {
  document.getElementById('projectForm').reset();
  state.projects.editIndex = null;
}

function clearServiceForm() {
  document.getElementById('serviceForm').reset();
  state.services.editIndex = null;
}

function clearFaqForm() {
  document.getElementById('faqForm').reset();
  state.faq.editIndex = null;
}

function clearTestimonialForm() {
  document.getElementById('testimonialForm').reset();
  state.testimonials.editIndex = null;
}

function clearCreditForm() {
  document.getElementById('creditForm').reset();
  state.credits.editIndex = null;
}

document.getElementById('productForm').addEventListener('submit', async (event) => {
  event.preventDefault();
  setStatus('productStatus', 'Traitement en cours‚Ä¶');

  const fileInput = document.getElementById('productImage');
  const customPath = document.getElementById('productImagePath').value.trim();
  const imagePath = customPath || (fileInput.files[0] ? `images/products/${fileInput.files[0].name}` : 'images/products/doc.jpg');

  const product = {
    ref: document.getElementById('productRef').value.trim(),
    name: document.getElementById('productName').value.trim(),
    type: document.getElementById('productType').value,
    price: document.getElementById('productPrice').value.trim(),
    description: document.getElementById('productDescription').value.trim(),
    image: imagePath,
    link: document.getElementById('productLink').value.trim()
  };

  if (!product.ref || !product.name) {
    setStatus('productStatus', 'R√©f√©rence et nom sont obligatoires.', 'error');
    return;
  }

  const data = [...state.products.data];
  if (state.products.editIndex !== null) {
@@ -288,61 +617,59 @@ document.getElementById('productForm').addEventListener('submit', async (event)
  } else {
    data.push(product);
  }

  async function finalize(updatedData) {
    try {
      const response = await updateFile('data/products.json', updatedData, state.products.sha, 'Mise √† jour produits depuis admin');
      state.products.sha = response.content.sha;
      state.products.data = updatedData;
      renderProductList();
      clearProductForm();
      document.getElementById('productImagePath').value = '';
      setStatus('productStatus', '‚úÖ Produit enregistr√© avec succ√®s.', 'success');
    } catch (error) {
      setStatus('productStatus', `‚ùå ${error.message}`, 'error');
      console.error(error);
    }
  }

  const file = fileInput.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onloadend = async () => {
      try {
        const base64Image = reader.result.split(',')[1];
          await fetch(buildContentUrl(imagePath), {
            method: 'PUT',
            headers: githubHeaders({ json: true }),
            body: JSON.stringify({
              message: `Ajout image ${file.name}`,
              content: base64Image,
              branch: repoBranch
            })
          });
        finalize(data);
      } catch (error) {
        setStatus('productStatus', `‚ùå ${error.message}`, 'error');
        console.error(error);
      }
    };
    reader.readAsDataURL(file);
  } else {
    finalize(data);
  }
});

document.getElementById('projectForm').addEventListener('submit', async (event) => {
  event.preventDefault();
  setStatus('projectStatus', 'Traitement en cours‚Ä¶');

  const project = {
    id: document.getElementById('projectId').value.trim(),
    title: document.getElementById('projectTitle').value.trim(),
    summary: document.getElementById('projectSummary').value.trim(),
    thumbnail: document.getElementById('projectThumbnail').value.trim(),
    description: document.getElementById('projectDescription').value.trim(),
    highlights: document.getElementById('projectHighlights').value.split('\n').map((item) => item.trim()).filter(Boolean),
    services: document.getElementById('projectServices').value.split(',').map((item) => item.trim()).filter(Boolean),
    gallery: document.getElementById('projectGallery').value.split(',').map((item) => item.trim()).filter(Boolean),
@@ -353,50 +680,200 @@ document.getElementById('projectForm').addEventListener('submit', async (event)
  if (!project.id || !project.title) {
    setStatus('projectStatus', 'Identifiant et titre sont obligatoires.', 'error');
    return;
  }

  const data = [...state.projects.data];
  if (state.projects.editIndex !== null) {
    data[state.projects.editIndex] = project;
  } else {
    data.push(project);
  }

  try {
    const response = await updateFile('data/projects.json', data, state.projects.sha, 'Mise √† jour projets depuis admin');
    state.projects.sha = response.content.sha;
    state.projects.data = data;
    renderProjectList();
    clearProjectForm();
    setStatus('projectStatus', '‚úÖ Projet enregistr√© avec succ√®s.', 'success');
  } catch (error) {
    setStatus('projectStatus', `‚ùå ${error.message}`, 'error');
    console.error(error);
  }
});

document.getElementById('serviceForm').addEventListener('submit', async (event) => {
  event.preventDefault();
  setStatus('serviceStatus', 'Traitement en cours‚Ä¶');

  const service = {
    slug: document.getElementById('serviceSlug').value.trim(),
    title: document.getElementById('serviceTitle').value.trim(),
    icon: document.getElementById('serviceIcon').value.trim(),
    tagline: document.getElementById('serviceTagline').value.trim(),
    summary: document.getElementById('serviceSummary').value.trim(),
    details: document.getElementById('serviceDetails').value.trim(),
    deliverables: document.getElementById('serviceDeliverables').value.split('\n').map((item) => item.trim()).filter(Boolean),
    tools: document.getElementById('serviceTools').value.split(',').map((item) => item.trim()).filter(Boolean),
    price: document.getElementById('servicePrice').value.trim(),
    turnaround: document.getElementById('serviceTurnaround').value.trim(),
    cta: document.getElementById('serviceCta').value.trim(),
    ctaLink: document.getElementById('serviceCtaLink').value.trim()
  };

  if (!service.slug || !service.title || !service.details) {
    setStatus('serviceStatus', 'Slug, titre et description sont obligatoires.', 'error');
    return;
  }

  const data = [...state.services.data];
  if (state.services.editIndex !== null) {
    data[state.services.editIndex] = service;
  } else {
    data.push(service);
  }

  try {
    const response = await updateFile('data/services.json', data, state.services.sha, 'Mise √† jour services depuis admin');
    state.services.sha = response.content.sha;
    state.services.data = data;
    renderServiceList();
    clearServiceForm();
    setStatus('serviceStatus', '‚úÖ Service enregistr√©.', 'success');
  } catch (error) {
    setStatus('serviceStatus', `‚ùå ${error.message}`, 'error');
    console.error(error);
  }
});

document.getElementById('faqForm').addEventListener('submit', async (event) => {
  event.preventDefault();
  setStatus('faqStatus', 'Traitement en cours‚Ä¶');

  const item = {
    question: document.getElementById('faqQuestion').value.trim(),
    answer: document.getElementById('faqAnswer').value.trim()
  };

  if (!item.question || !item.answer) {
    setStatus('faqStatus', 'Question et r√©ponse sont obligatoires.', 'error');
    return;
  }

  const data = [...state.faq.data];
  if (state.faq.editIndex !== null) {
    data[state.faq.editIndex] = item;
  } else {
    data.push(item);
  }

  try {
    const response = await updateFile('data/faq.json', data, state.faq.sha, 'Mise √† jour FAQ depuis admin');
    state.faq.sha = response.content.sha;
    state.faq.data = data;
    renderFaqList();
    clearFaqForm();
    setStatus('faqStatus', '‚úÖ Question enregistr√©e.', 'success');
  } catch (error) {
    setStatus('faqStatus', `‚ùå ${error.message}`, 'error');
    console.error(error);
  }
});

document.getElementById('testimonialForm').addEventListener('submit', async (event) => {
  event.preventDefault();
  setStatus('testimonialStatus', 'Traitement en cours‚Ä¶');

  const item = {
    quote: document.getElementById('testimonialQuote').value.trim(),
    author: document.getElementById('testimonialAuthor').value.trim(),
    role: document.getElementById('testimonialRole').value.trim()
  };

  if (!item.quote || !item.author) {
    setStatus('testimonialStatus', 'Citation et auteur sont obligatoires.', 'error');
    return;
  }

  const data = [...state.testimonials.data];
  if (state.testimonials.editIndex !== null) {
    data[state.testimonials.editIndex] = item;
  } else {
    data.push(item);
  }

  try {
    const response = await updateFile('data/testimonials.json', data, state.testimonials.sha, 'Mise √† jour t√©moignages depuis admin');
    state.testimonials.sha = response.content.sha;
    state.testimonials.data = data;
    renderTestimonialList();
    clearTestimonialForm();
    setStatus('testimonialStatus', '‚úÖ T√©moignage enregistr√©.', 'success');
  } catch (error) {
    setStatus('testimonialStatus', `‚ùå ${error.message}`, 'error');
    console.error(error);
  }
});

document.getElementById('creditForm').addEventListener('submit', async (event) => {
  event.preventDefault();
  setStatus('creditStatus', 'Traitement en cours‚Ä¶');

  const item = {
    title: document.getElementById('creditTitle').value.trim(),
    type: document.getElementById('creditType').value.trim(),
    author: document.getElementById('creditAuthor').value.trim(),
    license: document.getElementById('creditLicense').value.trim(),
    url: document.getElementById('creditUrl').value.trim()
  };

  if (!item.title || !item.author) {
    setStatus('creditStatus', 'Titre et auteur sont obligatoires.', 'error');
    return;
  }

  const data = [...state.credits.data];
  if (state.credits.editIndex !== null) {
    data[state.credits.editIndex] = item;
  } else {
    data.push(item);
  }

  try {
    const response = await updateFile('data/credits.json', data, state.credits.sha, 'Mise √† jour cr√©dits depuis admin');
    state.credits.sha = response.content.sha;
    state.credits.data = data;
    renderCreditList();
    clearCreditForm();
    setStatus('creditStatus', '‚úÖ Cr√©dit enregistr√©.', 'success');
  } catch (error) {
    setStatus('creditStatus', `‚ùå ${error.message}`, 'error');
    console.error(error);
  }
});

function editProduct(index) {
  const product = state.products.data[index];
  document.getElementById('productRef').value = product.ref;
  document.getElementById('productName').value = product.name;
  document.getElementById('productType').value = product.type;
  document.getElementById('productPrice').value = product.price;
  document.getElementById('productDescription').value = product.description;
  document.getElementById('productImagePath').value = product.image;
  document.getElementById('productLink').value = product.link || '';
  state.products.editIndex = index;
  setStatus('productStatus', '‚úèÔ∏è Produit charg√© pour √©dition. Enregistre pour appliquer les modifications.');
}

async function deleteProduct(index) {
  if (!confirm('Supprimer ce produit ?')) return;
  const data = [...state.products.data];
  data.splice(index, 1);
  try {
    const response = await updateFile('data/products.json', data, state.products.sha, 'Suppression produit depuis admin');
    state.products.sha = response.content.sha;
    state.products.data = data;
    renderProductList();
    clearProductForm();
    setStatus('productStatus', '‚úÖ Produit supprim√©.', 'success');
  } catch (error) {
@@ -415,28 +892,142 @@ function editProject(index) {
  document.getElementById('projectHighlights').value = (project.highlights || []).join('\n');
  document.getElementById('projectServices').value = (project.services || []).join(', ');
  document.getElementById('projectGallery').value = (project.gallery || []).join(', ');
  document.getElementById('projectCta').value = project.cta || '';
  document.getElementById('projectCtaLink').value = project.ctaLink || '';
  state.projects.editIndex = index;
  setStatus('projectStatus', '‚úèÔ∏è Projet charg√© pour √©dition.');
}

async function deleteProject(index) {
  if (!confirm('Supprimer ce projet ?')) return;
  const data = [...state.projects.data];
  data.splice(index, 1);
  try {
    const response = await updateFile('data/projects.json', data, state.projects.sha, 'Suppression projet depuis admin');
    state.projects.sha = response.content.sha;
    state.projects.data = data;
    renderProjectList();
    clearProjectForm();
    setStatus('projectStatus', '‚úÖ Projet supprim√©.', 'success');
  } catch (error) {
    setStatus('projectStatus', `‚ùå ${error.message}`, 'error');
    console.error(error);
  }
}

function editService(index) {
  const service = state.services.data[index];
  document.getElementById('serviceSlug').value = service.slug || '';
  document.getElementById('serviceTitle').value = service.title || '';
  document.getElementById('serviceIcon').value = service.icon || '';
  document.getElementById('serviceTagline').value = service.tagline || '';
  document.getElementById('serviceSummary').value = service.summary || '';
  document.getElementById('serviceDetails').value = service.details || '';
  document.getElementById('serviceDeliverables').value = (service.deliverables || []).join('\n');
  document.getElementById('serviceTools').value = (service.tools || []).join(', ');
  document.getElementById('servicePrice').value = service.price || '';
  document.getElementById('serviceTurnaround').value = service.turnaround || '';
  document.getElementById('serviceCta').value = service.cta || '';
  document.getElementById('serviceCtaLink').value = service.ctaLink || '';
  state.services.editIndex = index;
  setStatus('serviceStatus', '‚úèÔ∏è Service charg√© pour √©dition.');
}

async function deleteService(index) {
  if (!confirm('Supprimer ce service ?')) return;
  const data = [...state.services.data];
  data.splice(index, 1);
  try {
    const response = await updateFile('data/services.json', data, state.services.sha, 'Suppression service depuis admin');
    state.services.sha = response.content.sha;
    state.services.data = data;
    renderServiceList();
    clearServiceForm();
    setStatus('serviceStatus', '‚úÖ Service supprim√©.', 'success');
  } catch (error) {
    setStatus('serviceStatus', `‚ùå ${error.message}`, 'error');
    console.error(error);
  }
}

function editFaq(index) {
  const item = state.faq.data[index];
  document.getElementById('faqQuestion').value = item.question || '';
  document.getElementById('faqAnswer').value = item.answer || '';
  state.faq.editIndex = index;
  setStatus('faqStatus', '‚úèÔ∏è Question charg√©e pour √©dition.');
}

async function deleteFaq(index) {
  if (!confirm('Supprimer cette question ?')) return;
  const data = [...state.faq.data];
  data.splice(index, 1);
  try {
    const response = await updateFile('data/faq.json', data, state.faq.sha, 'Suppression question FAQ depuis admin');
    state.faq.sha = response.content.sha;
    state.faq.data = data;
    renderFaqList();
    clearFaqForm();
    setStatus('faqStatus', '‚úÖ Question supprim√©e.', 'success');
  } catch (error) {
    setStatus('faqStatus', `‚ùå ${error.message}`, 'error');
    console.error(error);
  }
}

function editTestimonial(index) {
  const item = state.testimonials.data[index];
  document.getElementById('testimonialQuote').value = item.quote || '';
  document.getElementById('testimonialAuthor').value = item.author || '';
  document.getElementById('testimonialRole').value = item.role || '';
  state.testimonials.editIndex = index;
  setStatus('testimonialStatus', '‚úèÔ∏è T√©moignage charg√© pour √©dition.');
}

async function deleteTestimonial(index) {
  if (!confirm('Supprimer ce t√©moignage ?')) return;
  const data = [...state.testimonials.data];
  data.splice(index, 1);
  try {
    const response = await updateFile('data/testimonials.json', data, state.testimonials.sha, 'Suppression t√©moignage depuis admin');
    state.testimonials.sha = response.content.sha;
    state.testimonials.data = data;
    renderTestimonialList();
    clearTestimonialForm();
    setStatus('testimonialStatus', '‚úÖ T√©moignage supprim√©.', 'success');
  } catch (error) {
    setStatus('testimonialStatus', `‚ùå ${error.message}`, 'error');
    console.error(error);
  }
}

function editCredit(index) {
  const item = state.credits.data[index];
  document.getElementById('creditTitle').value = item.title || '';
  document.getElementById('creditType').value = item.type || '';
  document.getElementById('creditAuthor').value = item.author || '';
  document.getElementById('creditLicense').value = item.license || '';
  document.getElementById('creditUrl').value = item.url || '';
  state.credits.editIndex = index;
  setStatus('creditStatus', '‚úèÔ∏è Cr√©dit charg√© pour √©dition.');
}

async function deleteCredit(index) {
  if (!confirm('Supprimer ce cr√©dit ?')) return;
  const data = [...state.credits.data];
  data.splice(index, 1);
  try {
    const response = await updateFile('data/credits.json', data, state.credits.sha, 'Suppression cr√©dit depuis admin');
    state.credits.sha = response.content.sha;
    state.credits.data = data;
    renderCreditList();
    clearCreditForm();
    setStatus('creditStatus', '‚úÖ Cr√©dit supprim√©.', 'success');
  } catch (error) {
    setStatus('creditStatus', `‚ùå ${error.message}`, 'error');
    console.error(error);
  }
}
</script>
</body>
</html>
