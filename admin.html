<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Disensor</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      padding: 40px;
      max-width: 700px;
      margin: auto;
      background: #fff;
      color: #222;
      font-family: sans-serif;
    }
    label, input, textarea, select {
      display: block;
      width: 100%;
      margin-bottom: 15px;
      font-size: 1em;
    }
    input, textarea, select {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      padding: 12px 24px;
      font-size: 1em;
      background: #007acc;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #005fa3;
    }
    .hidden {
      display: none;
    }
    .status {
      margin: 20px 0;
      font-weight: bold;
      color: green;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>

<h1>Interface admin : Ajouter un produit</h1>

<div id="auth">
  <label for="token">Entre ton token GitHub :</label>
  <input type="password" id="token" placeholder="ghp_...">
  <button onclick="auth()">Se connecter</button>
</div>

<form id="adminForm" class="hidden">
  <label for="ref">Référence</label>
  <input type="text" id="ref">

  <label for="name">Nom du produit</label>
  <input type="text" id="name">

  <label for="type">Type de fichier</label>
  <select id="type">
    <option value="STL">STL</option>
    <option value="STEP">STEP</option>
    <option value="PDF">PDF</option>
  </select>

  <label for="price">Prix</label>
  <input type="text" id="price">

  <label for="description">Description</label>
  <textarea id="description" rows="4"></textarea>

  <label for="imageUpload">Image à téléverser</label>
  <input type="file" id="imageUpload" accept="image/*">

  <button type="submit">Ajouter le produit</button>
</form>
<div id="status" class="status hidden"></div>

<script>
let githubToken = '';
const repoOwner = 'LuanCaillavet';
const repoName = 'disensor.github.io';

function auth() {
  githubToken = document.getElementById('token').value.trim();
  fetch("https://api.github.com/user", {
    headers: {
      Authorization: `Bearer ${githubToken}`,
      Accept: 'application/vnd.github+json'
    }
  }).then(res => {
    if (res.ok) {
      document.getElementById('auth').classList.add('hidden');
      document.getElementById('adminForm').classList.remove('hidden');
    } else {
      alert("Token invalide ou non autorisé.");
    }
  });
}

document.getElementById('adminForm').addEventListener('submit', async function (e) {
  e.preventDefault();
  const status = document.getElementById('status');
  status.classList.remove('hidden');
  status.textContent = 'Traitement en cours...';

  const file = document.getElementById('imageUpload').files[0];
  const ref = document.getElementById('ref').value.trim();
  const name = document.getElementById('name').value.trim();
  const imagePath = file ? `images/products/${file.name}` : "";
  const product = {
    ref,
    name,
    type: document.getElementById('type').value,
    price: document.getElementById('price').value.trim(),
    description: document.getElementById('description').value.trim(),
    image: imagePath,
    link: `mailto:luan@example.com?subject=Commande ${ref} - ${name}`
  };

  try {
    const dataUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/data/products.json`;
    const dataRes = await fetch(dataUrl, {
      headers: { Authorization: `Bearer ${githubToken}` }
    });
    const data = await dataRes.json();
    const content = JSON.parse(atob(data.content));
    content.push(product);

    if (file) {
      const reader = new FileReader();
      reader.onloadend = async () => {
        const base64Image = reader.result.split(',')[1];
        const imageUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${imagePath}`;
        await fetch(imageUrl, {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${githubToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Ajout image ${file.name}`,
            content: base64Image
          })
        });
        updateJson(content, data.sha, status);
      };
      reader.readAsDataURL(file);
    } else {
      updateJson(content, data.sha, status);
    }
  } catch (err) {
    status.textContent = "Erreur : " + err.message;
    status.classList.add('error');
  }
});

async function updateJson(content, sha, statusEl) {
  const dataUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/data/products.json`;
  const res = await fetch(dataUrl, {
    method: 'PUT',
    headers: {
      Authorization: `Bearer ${githubToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      message: 'Ajout nouveau produit',
      content: btoa(JSON.stringify(content, null, 2)),
      sha
    })
  });

  if (res.ok) {
    statusEl.textContent = "✅ Produit ajouté avec succès !";
    document.getElementById('adminForm').reset();
  } else {
    const err = await res.json();
    statusEl.textContent = "❌ Erreur : " + err.message;
    statusEl.classList.add('error');
  }
}
</script>

</body>
</html>
