<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Disensor</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      padding: 40px;
      max-width: 700px;
      margin: auto;
      background: #fff;
      color: #222;
      font-family: sans-serif;
    }
    label, input, textarea, select {
      display: block;
      width: 100%;
      margin-bottom: 15px;
      font-size: 1em;
    }
    input, textarea, select {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      padding: 12px 24px;
      font-size: 1em;
      background: #007acc;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #005fa3;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<h1>Interface admin : Ajouter ou modifier un produit</h1>

<div id="auth">
  <label for="token">Entre ton token GitHub :</label>
  <input type="password" id="token" placeholder="ghp_...">
  <button onclick="auth()">Se connecter</button>
</div>

<form id="adminForm" class="hidden">
  <label for="ref">Référence</label>
  <input type="text" id="ref">

  <label for="name">Nom du produit</label>
  <input type="text" id="name">

  <label for="type">Type de fichier</label>
  <select id="type">
    <option value="STL">STL</option>
    <option value="STEP">STEP</option>
    <option value="PDF">PDF</option>
  </select>

  <label for="price">Prix</label>
  <input type="text" id="price">

  <label for="description">Description</label>
  <textarea id="description" rows="4"></textarea>

  <label for="imageUpload">Image à téléverser (optionnel)</label>
  <input type="file" id="imageUpload" accept="image/*">

  <button type="submit">Valider</button>
</form>

<script>
  let githubToken = '';
  const repoOwner = 'LuanCaillavet';
  const repoName = 'disensor.github.io';

  async function auth() {
    githubToken = document.getElementById('token').value.trim();
    const response = await fetch("https://api.github.com/user", {
      headers: {
        Authorization: `Bearer ${githubToken}`,
        Accept: 'application/vnd.github+json'
      }
    });

    if (response.ok) {
      document.getElementById('auth').classList.add('hidden');
      document.getElementById('adminForm').classList.remove('hidden');
    } else {
      alert("❌ Token invalide ou non autorisé.");
    }
  }

  document.getElementById('adminForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const file = document.getElementById('imageUpload').files[0];
    const imagePath = file ? `images/products/${file.name}` : null;

    const product = {
      ref: document.getElementById('ref').value,
      name: document.getElementById('name').value,
      type: document.getElementById('type').value,
      price: document.getElementById('price').value,
      description: document.getElementById('description').value,
      image: imagePath || '',
      link: `mailto:luan@example.com?subject=Commande ${document.getElementById('ref').value} - ${document.getElementById('name').value}`
    };

    const dataPath = "data/products.json";
    const dataUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${dataPath}`;
    const dataRes = await fetch(dataUrl, {
      headers: { Authorization: `Bearer ${githubToken}` }
    });

    const data = await dataRes.json();
    const content = JSON.parse(atob(data.content));
    content.push(product);

    const updateBody = {
      message: `Ajout produit ${product.ref}`,
      content: btoa(JSON.stringify(content, null, 2)),
      sha: data.sha
    };

    if (file) {
      const reader = new FileReader();
      reader.onloadend = async () => {
        const base64Image = reader.result.split(',')[1];
        const imageUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${imagePath}`;

        const uploadRes = await fetch(imageUrl, {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${githubToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Ajout image ${file.name}`,
            content: base64Image
          })
        });

        if (!uploadRes.ok) return alert("❌ Échec de l'envoi de l'image.");

        // upload JSON après image
        const update = await fetch(dataUrl, {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${githubToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updateBody)
        });

        update.ok ? alert("✅ Produit et image ajoutés !") : alert("❌ Erreur JSON.");
      };
      reader.readAsDataURL(file);
    } else {
      const update = await fetch(dataUrl, {
        method: 'PUT',
        headers: {
          Authorization: `Bearer ${githubToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(updateBody)
      });

      update.ok ? alert("✅ Produit ajouté !") : alert("❌ Erreur JSON sans image.");
    }
  });
</script>

</body>
</html>
